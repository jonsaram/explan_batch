<meta charset="utf-8">
<script type="text/javascript">
	var <@pageId> = {
			
		 loadComponent : function(parm) {
			 
	   		let startDate 	= $("#<@pageId> #startDate"	).val();
			let endDate 	= $("#<@pageId> #endDate"	).val();
			let searchWord 	= $("#<@pageId> #searchWord").val();
			 
			let sendParm = {
					gridParm : {
					 requestQuery 	: {
						  queryId		: "contract.getContractList"
						 ,requestParm	: {
		                	 startDate 	: startDate
		                 	,endDate 	: endDate
		                 	,searchWord : searchWord
		                 }
					 }	
					,columnMap 			: {
						 "CONTRACT_ID" 		: { headerText : "CONTRACT_ID"	, hidden : "Y"		}
						,"BUYER_ID" 		: { headerText : "고객번호"		, width : "90px"	}
						,"BUYER_NM" 		: { headerText : "고객명"							}
						,"PROCESS_STATE"	: { headerText : "PROCESS_STATE", hidden : "Y"		}
						,"PROCESS_STATE_NM"	: { headerText : "진행상태"							}
						,"CONTACT_DATE"		: { headerText : "상담일" 		, width : "115px", dataType :'date' , dateFormat:'YYYY-MM-DD HH24:MI:SS'	}
						,"USER_ID"			: { headerText : "USER_ID"		, hidden : "Y"		}
						,"USER_NM"			: { headerText : "담당자"		, width : "90px"	}
						,"CONSULTING_TYPE_NM":{ headerText : "계약구분"							}
						,"CONTRACT_DATE"	: { headerText : "계약일"		, width : "115px", dataType :'date' , dateFormat:'YYYY-MM-DD HH24:MI:SS'	}
						,"EXPIRE_DATE"		: { headerText : "만료일"		, width : "115px", dataType :'date' , dateFormat:'YYYY-MM-DD HH24:MI:SS'	}
						,"TOTAL_COST"		: { headerText : "계약금액"							}
						,"CONSULTING_NM"	: { headerText : "컨설팅명"							}
						,"RECOMMENDER_ID"	: { headerText : "RECOMMENDER_ID"	, hidden : "Y"	}
						,"RECOMMENDER_NM"	: { headerText : "RECOMMENDER_NM"	, hidden : "Y"	}
						,"CONTRACT_TYPE"	: { headerText : "CONTRACT_TYPE"	, hidden : "Y"	}
						,"CONSULTING_ID"	: { headerText : "CONSULTING_ID"	, hidden : "Y"	}
						,"CONSULTING_NM"	: { headerText : "CONSULTING_NM"	, hidden : "Y"	}
						,"CONSULTING_TYPE"	: { headerText : "CONSULTING_TYPE"	, hidden : "Y"	}
						,"CONSULTING_CLASS"	: { headerText : "CONSULTING_CLASS"	, hidden : "Y"	}
						,"CONSULTANT_USER_ID":{ headerText : "CONSULTANT_USER_ID",hidden : "Y"	}
						,"CONSULTANT_USER_NM":{ headerText : "CONSULTANT_USER_NM",hidden : "Y"	}
 						,"APP_STATE_NM"		: { headerText : "결재"			, noSave : "Y"		}
 						,"MOD"				: { headerText : "변경"			, noSave : "Y", width : "80px"}
 						,"DEL"				: { headerText : "삭제"			, noSave : "Y", width : "80px"}
					 }
					,rowCntId 			: "<@pageId>_rowCnt"
					,primaryKeyList		: ["C.BUYER_ID","CONSULTING_ID","C.USER_ID"							]
					,searchColumnList	: ["C.BUYER_ID","GET_USER_NM(C.USER_ID)","C.PROCESS_STATE"			]
					,orderColumnList 	: ["C.UPDATE_DATE DESC","C.BUYER_ID","C.USER_ID","CONSULTING_ID"	]
					,columnConfig		: {
						makeCellViewData	: {
							// 결재
							"APP_STATE_NM": function(cellText, rowData) {
								const state = rowData.PROCESS_STATE;
								let encodedRowData = encodeURIComponent(JSON.stringify(rowData));
								let stateStr =  state == "CONTRACTED"			? `<button class="outline-btn" onclick="<@pageId>.approval('${encodedRowData}')">완료 결재</button>` :
												state == "CONTRACTING"			? `<button class="outline-btn" onclick="<@pageId>.approval('${encodedRowData}')">체결 결재</button>` :
												cellText;
								return stateStr;
							}
							,// 진행상태
							"PROCESS_STATE_NM": function(cellText, rowData) {
								const state = rowData.PROCESS_STATE;
								let stateStr =  state == "COMPLETED" 			? `<span class="status-complete"	>${rowData.PROCESS_STATE_NM}</span>` :
												state == "PENDING"   			? `<span class="status-companion"	>${rowData.PROCESS_STATE_NM}</span>` :
												state == "ON_COMPLETED_APPR"	? `<span class="status-approve"		>${rowData.PROCESS_STATE_NM}</span>` :
												state == "CONTRACTED"			? `<span class="status-ing"			>${rowData.PROCESS_STATE_NM}</span>` :
												state == "CONTRACTING"			? `<span class="status-companion"	>${rowData.PROCESS_STATE_NM}</span>` :
												state == "CANCEL"   			? `<span class="status-companion"	>${rowData.PROCESS_STATE_NM}</span>` :
												"";
		
								return stateStr;
							}
							,
							"MOD": function(cellText, rowData) {
								let encodedRowData = encodeURIComponent(JSON.stringify(rowData));
								return `<button class="explan_msg-edit" onclick="<@pageId>.modify('${encodedRowData}')"/>`;
							}
							,
							"DEL": function(cellText, rowData) {
								let encodedRowData = encodeURIComponent(JSON.stringify(rowData));
								const state = rowData.PROCESS_STATE;
								let stateStr =  state != "COMPLETED"			? 
										`<button class="explan_msg-del" onclick="<@pageId>.deleteRow('${encodedRowData}')"/>` :cellText;
								return stateStr;
							}
						}
						,onClickCell		: function(column) {
						}					
					}
					,rowConfig		: {
						onClickRow : function(rowData) {}

					 }
					,readOnly	: "Y"
				 }
				,optionConfig		: {
					searchComponentList : [
						{
							 type			: "term"	
							,title			: "검색기간"
							,whereColumn	: "APPROVAL_DATE"
						}
					]
				 }
				,noEdit : "Y"
			}
			C_COMP.import("<@pageId>_editor", "component_compTableEditor",sendParm , function() {});	
			
		 }
		,approval : function(encodedRowData){

			const selectedRow = JSON.parse(decodeURIComponent(encodedRowData));
			
			// @import CALL_TYPE 이 USER이면 biz 폴더 호출.
			if( "<@CALL_TYPE>" == "USER"){
				
				const USER_ID = G_VAL.session.USER_ID ; 
				const contractUser = selectedRow.USER_ID;
				const consultingUser = selectedRow.CONSULTANT_USER_ID;
				
				if( USER_ID != contractUser && USER_ID != consultingUser){
					
					C_POP.alert("계약 담당자이거나 실행 컨설턴트인 경우만 결재 상신 할 수 있습니다. ");
					return;
				}
				
				if( selectedRow["PROCESS_STATE"] == 'CONTRACTED' &&  USER_ID != consultingUser){
					C_POP.alert("실행 컨설턴트인 경우만 실행완료 결재 상신 할 수 있습니다. ");
					return;
				}	
			}
			
			if( isEmpty(selectedRow["CONTRACT_DATE"]) || isEmpty(selectedRow["TOTAL_COST"]) ){
				
				C_POP.alert("계약일, 계약금액 등 계약 체결을 위한\n필수 항목 입력 후 결재 할 수 있습니다.");
				return;
			}	

			let afterState	= "";
			let title 		= "";
			let appTitle	= "";
			let buyerNm 	= selectedRow.BUYER_NM;
			let consultingNm= selectedRow.CONSULTING_NM;
			if( selectedRow["PROCESS_STATE"] == 'CONTRACTING' ){title	= `${buyerNm} ${consultingNm} 계약 체결 완료 결재 요청`;afterState	= "CONTRACTED";}
			if( selectedRow["PROCESS_STATE"] == 'CONTRACTED'  ){title	= `${buyerNm} ${consultingNm} 실행 완료 결재 요청`;		afterState	= "COMPLETED" ;}
			appTitle	= title.replace(" 결재 요청","");
			
			const totalCost = addComma(selectedRow.TOTAL_COST);
			let appContent   = `<B>* 고객명			:</B> ${selectedRow.BUYER}<BR>`;
			appContent 		+= `<B>* 계약담당자 	:</B> ${selectedRow.USER}<BR>`;
			appContent 		+= `<B>* 상품명 		:</B> ${selectedRow.CONSULTING_NM}(${selectedRow.CONSULTING_TYPE_NM})<BR>`;
			appContent 		+= `<B>* 상담일 		:</B> ${selectedRow.CONTACT_DATE}<BR>`;
			appContent 		+= `<B>* 계약일 		:</B> ${selectedRow.CONTRACT_DATE}<BR>`;
			appContent 		+= `<B>* 만료일 		:</B> ${selectedRow.EXPIRE_DATE}<BR>`;
			appContent 		+= `<B>* 계약금액 		:</B> ${totalCost}원<BR>`;
			appContent 		+= `<B>* 계약구분 		:</B> ${selectedRow.CONSULTING_TYPE_NM}<BR>`;
			appContent 		+= `<BR>위와 같이<B>[${appTitle}]</B>에 대한 결재를 요청 합니다.<BR>`;
			
			const CONTRACT_ID	= selectedRow["CONTRACT_ID"];

			let requestParm = {
		        	 RELATION_ID 	: CONTRACT_ID
		        	,AFTER_SERVICE	: `ApprovalAfterService.updateContractProcess`
		        	,AFTER_PARM		: `{"PROCESS_STATE" : "${afterState}" }`
		        	,TITLE			: title
		        	,CONTENTS		: appContent
		        	,size			: "MAX"
			}
			
	        C_POP.open('popup_appr_approval', requestParm, function(retData) {
	        	
				if(retData.state == "S") {

					var parm = {
						 queryId 		: "contract.updateProject"
						,requestParm	: {
							 CONTRACT_ID 	: CONTRACT_ID
				        	,PROCESS_STATE	: `ON_${afterState}_APPR`
						}
					}
					C_COM.requestQuery(parm, function(resultData) {
						if(resultData.state == "S") {
							<@pageId>.<@pageId>_editor.reload();
						} else {
							C_POP.alert('결재상신 상태값 갱신 중 문제가 발생 했습니다.');
						}
					});  
				}
	        });			
		}
		,deleteRow : (encodedRowData) =>{
			const selectedRow = JSON.parse(decodeURIComponent(encodedRowData));
	    	C_POP.confirm('선택하신 계약정보를 삭제 하시겠습니까?', function() {
	    		const CONTRACT_ID	= selectedRow["CONTRACT_ID"];

				var parm = {
						 queryId 		: "contract.deleteContract"
						,requestParmList: [{CONTRACT_ID:CONTRACT_ID}]
				}
				C_COM.requestQuery(parm, function(resultData) {
					
					var parm = {
							 queryId 		: "contract.deleteContractMember"
							,requestParmList: delKey
					}
					C_COM.requestQuery(parm, function(resultData) {
						
						if( resultData.state == 'S'){
							
							<@pageId>.<@pageId>_editor.reload();
							
						}				
					});					
				});	    		
	    		
	    		
	    	});
		}
		,modify : (encodedRowData) =>{
			const selectedRow = JSON.parse(decodeURIComponent(encodedRowData));
			if( selectedRow["PROCESS_STATE"] == "CONTRACTING"){
			// 계약체결완료 결재 요청 단계에서 계약정보 수정 시 계약관련자 TBL_EXP_TEAM_MEMBER => TBL_EXP_CONTRACT_MEMBER 옮겨옴.
				var parm ={
						queryId 		: "contract.updateContractMemberFromTeam"
						,requestParm	: {CONTRACT_ID :selectedRow["CONTRACT_ID"] }
				}
	
				C_COM.requestQuery(parm, function(resultData) {
	
					if( resultData.state == "S"){
						
						<@pageId>.openPopup(selectedRow);
						
					}
				});
				
			}else{
				
				<@pageId>.openPopup(selectedRow);
				
			}			
			
		}	
		,openPopup : (selectedRow) => {

			selectedRow = selectedRow || {};	
			C_POP.open('popup_contract_contractUpdatePopup', {	param:selectedRow, mode:"U"//INSERT는 없음. 
																, processState 	 : selectedRow["PROCESS_STATE"]
														   		, processStateNm : selectedRow["PROCESS_STATE_NM"]}
				, function(retData) {

					if(isValid(retData)){

						<@pageId>.updateItem(retData);
						
					}else {
						
						//<@pageId>.<@pageId>_editor.reload(); NOT A FUNCTION!
						
					}
				}
			);
			
		}
		,updateItem : (param) => {

			const requestParm 	= param ? param : {} ;
			let	  requestParmCM = [];
			
			if( requestParm["CONTRACT_MEMBER"] ) 
			{
				requestParmCM = requestParm["CONTRACT_MEMBER"];  
				delete requestParm["CONTRACT_MEMBER"]; 
			};
			
			requestParm["SP_CSTM_ID"] = G_VAL.SP_CSTM_ID;
			if( !requestParm["CONTRACT_ID"] || requestParm["CONTRACT_ID"] == ''){
				requestParm["CONTRACT_ID"] = C_COM.makeUniqueId();
				
				requestParmCM.forEach( obj => obj.CONTRACT_ID = requestParm["CONTRACT_ID"]);
			}
			
			var parm ={
						queryId 		: "contract.updateContract"
						,requestParm	: requestParm
			}

			C_COM.requestQuery(parm, function(resultData) {

				if( resultData.state == "S"){

					C_COM.requestQuery({
						 queryId 		: "contract.deleteContractMember"
						,requestParm	: {CONTRACT_ID : requestParm["CONTRACT_ID"]}
					}, function(resultData) {

						const lastCnt = requestParmCM.length;
						requestParmCM.forEach( (member,index) => {
							
							C_COM.requestQuery({
								 queryId 		: "contract.updateContractMember"
								,requestParm	: member
							}, function(resultData) {

								if( resultData.state == "S" && lastCnt == index+1){
									
									<@pageId>.<@pageId>_editor.reload();
								
								} 
							});	
							
						})
						
					});
				
				}else{
					C_POP.alert(resultData.msg)
				}
			});				
		} 		
	}
	// Page Load가 완료된후 실행 된다.
	C_PM.onLoadPage("<@pageId>", function(parm) {
		<@pageId>.loadComponent(parm);
	});
	// History back으로 이동해왔을 경우 이루틴이 실행된다.
	C_HM.onReturn("<@pageId>", function(pageId, data) {

	});
</script>
<page-component>
    <!-- table area start -->
	<compnent id="<@pageId>_editor"></compnent>    
    <!-- table area end -->
</page-component>