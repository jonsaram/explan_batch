<meta charset="utf-8">
<script type="text/javascript">
	var <@pageId> = {
		 jumpCnt		: 30
		,updateMainStock : function() {
			C_POP.confirm('메인 재고 분석 정보를 업데이트 하시겠습니까?', function() {
				var parm = {
					queryGroup : [
						 {
			                 queryId        : "config.deleteMainStock"
		                    ,requestParm    : { BRAND_ID : G_VAL.session.BRAND_ID }
						 }
						,{
			                 queryId        : "config.updateMainStock"
		                    ,requestParm    : { BRAND_ID : G_VAL.session.BRAND_ID }
		                }
					]
				}
				C_COM.requestQuery(parm, function(resultData) {
					alert('업데이트를 완료 하였습니다.');
				});
			});
		 }
		,menuAutoMapping : function() {
			
			var parm = {
				queryGroup : [
					 {
						 queryId 		: "common.getWordGrpList"
						,requestParm	: { BRAND_ID : G_VAL.session.BRAND_ID}
					 }
					,{
						 queryId 		: "headerManage.getBrandMenuList"
						,requestParm	: { BRAND_ID : G_VAL.session.BRAND_ID}
					 }
					,{
						 queryId 		: "headerManage.getAllStoreMenuList"
						,requestParm	: { BRAND_ID : G_VAL.session.BRAND_ID}
					 }
				]
			}
			let resultData = C_COM.requestQuery(parm);
			
			let similarWordList = resultData.data["common.getWordGrpList"];
			let mainMenuList 	= resultData.data["headerManage.getBrandMenuList"];
			let storeMenuList 	= resultData.data["headerManage.getAllStoreMenuList"];

			let mainMenuMap		= arrayToMap(mainMenuList, "BRAND_MENU_CD");
			
			// 유사어 검색 대상에 포함.
			$.each(similarWordList, function() {
				let mainMenuObj = mainMenuMap[this.WORD_GRP_ID];
				let brandMenuCd = this.WORD_GRP_ID;
				let mainMenuNm 	= this.SIMILAR_WORD_NM;
				if(isEmpty(mainMenuObj)) mainMenuObj = {SELLING_PRICE : 0}			
				let item = {
					 "BRAND_MENU_CD" 	: brandMenuCd
					,"MENU_NM" 			: mainMenuNm
					,"SELLING_PRICE"	: mainMenuObj.SELLING_PRICE
				}
				mainMenuList.push(item);
			});

			let updateStoreMenuList = [];
			let total = storeMenuList.length;
			
			C_POP.confirm( `적용대상 ${total}건이 검색 되었습니다.\n\n메뉴 연결을 진행 하시겠습니까?`, function() {
				let fn = function(smenuList, idx, step) { 

					for(var ii = idx; ii < step; ii++) {
						let item = smenuList[ii];
						
						if(total == ii) break;
						
						let storeMenuNm = item.MENU_NM;
						let smenu 		= {rate : 0, recipeRate : 100}
						$.each(mainMenuList, function() {
							let recipeRate = 100;
							if(this.SELLING_PRICE != 0) recipeRate = Math.round(item.SELLING_PRICE / this.SELLING_PRICE * 100);

							let mainMenuNm = this.MENU_NM;
							let rate = getSimilarity(storeMenuNm, mainMenuNm);
							if(isEmpty(smenu.rate)) {
								smenu = this;
								smenu.rate 			= rate;
								smenu.recipeRate 	= recipeRate;
							} else {
								if(smenu.rate <= rate) {
									smenu = this;
									smenu.rate 		= rate;
									smenu.recipeRate= recipeRate;
								}
							}
							if(rate >= 100) return false;
						});
						if(smenu.rate == 100) smenu.recipeRate = 100;
						if(smenu.rate >= 70 && smenu.recipeRate > 30) {
							let mapData = {
								 STORE_ID 		: item	["STORE_ID"		]
								,MENU_ID		: item	["MENU_ID"		]
								,BRAND_MENU_CD	: smenu	["BRAND_MENU_CD"]
								,RECIPE_RATE	: smenu.recipeRate
							}
							
							updateStoreMenuList.push(mapData);
						}
					}
					
					if(updateStoreMenuList.length > 0 ) {
						var parm = {
							 queryId 			: "headerManage.updateStoreMenuMapping"
							,requestParmList	: updateStoreMenuList
						}
						C_COM.requestQuery(parm, function(resultData) {
							
							if(step > total) step = total;
							
							$("#logArea").val(`Exec Index ${step} / ${total}`);
							
							if(resultData.state == "S") {
								updateStoreMenuList = [];
								if(step != total) fn(storeMenuList, step, step + <@pageId>.jumpCnt);
							} else {
								alert('에러가 발생했습니다.');
								return false;
							}
						});
					} else {
						if(step > total) step = total;
						
						$("#logArea").val(`Exec Index ${step} / ${total}`);

						if(step != total) {
							setTimeout(function() {
								fn(storeMenuList, step, step + <@pageId>.jumpCnt);	
							}, 10);
						}
					}
				}
				
				fn( storeMenuList, 0, <@pageId>.jumpCnt );
			});
		 }
		,deleteAllMenuMapping : function() {
			
			C_POP.confirm('메뉴 전체 연결을 초기화 하시겠습니까?', function() {
				var parm = {
					 queryId 		: "common.deleteAllMenuMapping"
					,requestParm	: { BRAND_ID : G_VAL.session.BRAND_ID}
				}
				C_COM.requestQuery(parm, function() {
					C_POP.alert('완료 되었습니다.');
				});
			});
			
		 }
	}
	// Page Load가 완료된후 실행 된다.
	C_PM.onLoadPage("<@pageId>", function() {

	});
	// History back으로 이동해왔을 경우 이루틴이 실행된다.
	C_HM.onReturn("<@pageId>", function(pageId, data) {

	});
</script>
<page-component>

    <!-- sub title + button start -->
    <div class="sub-tit-allwrap mb10 mt20">
        <!-- title start -->
        <div class="sub-tit">개발자 설정</div>
    </div>
    <div>
	    <!-- sub title + button end -->
    	<button class="flat-btn col2-sm" type="button" onclick="<@pageId>.updateMainStock()" >Main 재고 현황 Update</button>
	    메인 재고 입출고 오류 개수를 Update한다.<br/><br/>

	    <button class="flat-btn col2-sm" type="button" onclick="<@pageId>.deleteAllMenuMapping()">전체 Store Menu 연결 삭제</button>
	    자동 메뉴 Mapping을 진행 하기 위해 이전 메뉴Mapping정보를 모두 삭제 한다.<br/><br/>

	    <button class="flat-btn col2-sm" type="button" onclick="<@pageId>.menuAutoMapping()">전체 Store Menu Mapping</button>
	    본사 메뉴와 가맹점 메뉴의 유사성에 따른 Mapping을 진행 한다.( 이전에 Mapping 정보가 없는 것만 Update한다.)<br/><br/>

	    <button class="flat-btn col2-sm" type="button" onclick="C_PM.movePage('main_system_menuManage')">메뉴 설정</button>
	    메뉴 관리<br/><br/>

	    <button class="flat-btn col2-sm" type="button" onclick="C_PM.movePage('main_system_roleManage')">Role 설정</button>
	    Role 관리<br/><br/>




    </div>
    <div>
    	<br/>
	    <textarea cols=100 rows=10 id=logArea></textarea>
    </div>
    
    
	
</page-component>