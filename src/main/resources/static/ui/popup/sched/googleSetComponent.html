<meta charset="utf-8">
<script type="text/javascript">

var <@compId> = {
        GOOGLE_ORG_CALENDAR_ID : ''
       ,GOOGLE_CERT  : false 
       ,TOKEN_CLIENT : ''
       ,GAPI_INITED  : false
       ,GIS_INITED   : false

       
       ,init : function(data) {
            <@compId>.getUserInfo();
       }
       ,close : function() {
           var obj = new Object();
           C_POP.close(obj);
        }
       ,getUserInfo : function() {

           let requestParm = {};
           let parm = {
                queryId        : "schedule.getUserInfo"
               ,requestParm    : requestParm
           }
           C_COM.requestQuery(parm, function(resultData) {
              
               for(var i =0; i < resultData.data.length; i++){
                   if( resultData.data[i] != null){
                       <@compId>.GOOGLE_ORG_CALENDAR_ID = resultData.data[i].GOOGLE_CALENDAR_ID;
                       $('#<@compId>_googleCalendarId').val(<@compId>.GOOGLE_ORG_CALENDAR_ID);
                       if( resultData.data[i].GOOGLE_CALENDAR_SYN_YN == "Y"){
                           $('#<@compId>_synch_Y').prop('checked', true);
                       }else{
                           $('#<@compId>_synch_N').prop('checked', true);
                       }
                   }else{
                       $('#<@compId>_synch_N').prop('checked', true);
                   }
               }
            });
        }
       ,save : function( ) {
           
           var selectedValue = $('input[name="<@compId>_synch"]:checked').val();
           var googleCalendarId = $('#<@compId>_googleCalendarId').val();
           
           if( "Y" == selectedValue){
           //동기여부 동기 선택
               if( <@compId>.GOOGLE_ORG_CALENDAR_ID != googleCalendarId){
                   //기존 캘린더ID가 변경되었을 경우 구글인증을 한다.
                   if( !(<@compId>.GOOGLE_CERT)){
                       C_POP.alert("구글인증을 해주세요");
                       return;
                   }
               }
           }
           
           if (googleCalendarId.length < 2) {
               C_POP.alert("캘린더 ID를 입력하세요");
               $("#<@compId>_googleCalendarId").focus();
               return true;
           }
           
           let requestParm = {};
           requestParm["googleCalendarId"] = googleCalendarId;
           requestParm["googleCalendarSynYn"] = selectedValue;
           
           var parm = {
                    queryId        : "schedule.saveUserGoogleCalendar"
                   ,requestParm    : requestParm
           }
           C_COM.requestQuery(parm, function(resultData) {
               if( resultData.state == 'S'){
                   var obj = new Object();
                   obj.refresh = 'Y';
                   C_POP.alert("저장 되었습니다.");
                   C_POP.close(obj);
               }else{
                   C_POP.alert("저장에 실패 하였습니다.");
               }
           });
       }
       ,googleCert : function( ) {  
           console.log("googleCert");
           <@compId>.gapiLoaded();
           <@compId>.gisLoaded();
           
           <@compId>.TOKEN_CLIENT.callback = async (response) => {
                if (response.error !== undefined) {
                    console.log("googleCert response.error ");
                    throw(response);
                }
                <@compId>.checkCalendar();
            };

            if (gapi.client.getToken() === null) {
                // Prompt the user to select a Google Account and ask for consent to share their data
                <@compId>.TOKEN_CLIENT.requestAccessToken({prompt: 'consent'});
            } else {
                // Skip display of the account chooser and consent dialog for an existing Google Account
                <@compId>.TOKEN_CLIENT.requestAccessToken({prompt: ''});
            }
        }
       /*=============================================================================================*/
       /* google API함수    google API함수    google API함수    google API함수    google API함수       */
       
      ,gapiLoaded : function() {
           gapi.load('client', () => {
               <@compId>.initializeGapiClient()//클라이언트를 초기화
                   .then(() => {
                   })
                   .catch(error => {
                       console.error('Error loading GAPI client:', error);
                   });
           });
       }
      ,initializeGapiClient: async function() {
           await gapi.client.init({
               apiKey: _API_KEY,
               discoveryDocs: _DISCOVERY_DOCS,
           });
           <@compId>.GAPI_INITED = true;
           $('#<@compId>_btnCert').prop('disabled', false).addClass('disabled');
       }

      ,gisLoaded : function( ) {
          //GIS 스크립트가 로드된 후 호출
          try {
                  <@compId>.TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({ //OAuth2 토큰 클라이언트를 초기화
                  client_id: _CLIENT_ID,
                  scope: _SCOPES,
                  callback: (response) => {
                      if (response.error !== undefined) {
                          throw(response);
                      }
                  }
              });
              <@compId>.GIS_INITED = true;
          } catch (error) {
              console.error('Error loading GIS client:', error);
          }
          
       }


      ,checkCalendar: async function() {
           var calendarId = $('#<@compId>_googleCalendarId').val();
           console.log("calendarId ==>"+calendarId);
           const isValid = await <@compId>.validateCalendarId(calendarId);
           if (isValid) {
               C_POP.alert("구글인증에 성공하였습니다.");
               <@compId>.GOOGLE_CERT = true;
           } else {
               C_POP.alert("구글인증에 문제가 발생하였습니다.\n 캘린더 ID를 확인하세요");
           }
       }

      ,validateCalendarId: async function( calendarId ) {     

       // 현재 시간을 기준으로 오늘의 시작과 끝 시간을 계산
          const now = new Date();
          const timeMin = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString(); // 오늘의 자정
          const timeMax = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString(); // 내일 자정
          var apiKey = _API_KEY;
          console.log("validateCalendarId 1 apiKey ==>"+apiKey);
          console.log("validateCalendarId 1 calendarId ==>"+calendarId);
          try {
              var url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}`;
              const response = await fetch(url);
              // 응답 상태 확인
              if (!response.ok) {
                  // 404 오류 또는 다른 오류 발생 시 false 반환
                  console.error(`Error: ${response.status} ${response.statusText}`);
                  return false;
              }
              return true;
          } catch (error) {
              console.error("Error validating Calendar ID: ", error);
              return false;
          }
       }
      
     ,validateCalendarId1: async function( calendarId ) {     
          try {
              const response = await gapi.client.calendar.calendars.get({
                  'calendarId': calendarId
              });
              if (response.result && response.result.id) {
                  return true;
              } else {
                  return false;
              }
          } catch (error) {
              console.error("Error validating Calendar ID: ", error);
              return false;
          }
      }

      /* google API함수    google API함수    google API함수    google API함수    google API함수       */
      /*=============================================================================================*/
   }//var <@compId>
   
    // Popup Load가 완료된후 실행 된다.
    C_COMP.onLoadComp("<@compId>", function(data) {

        <@compId>.init(data);// 초기화
    });
</script>
<component>
  <div class="modal-body explan-table-allwrap explan-mxhgt500">
    <table class="col10">
      <colgroup>
        <col>
        <col>
      </colgroup>
      <tbody>
        <tr>
          <th class="col2 col2-sm col10-xs">캘린더 ID</th>
          <td class="col8 col8-sm col10-xs"><input type="text" id="<@compId>_googleCalendarId"  class="form-control form-control-sm col10" ></td>
        </tr>
        <tr>
          <th class="col2 col2-sm col10-xs">동기여부</th>
          <td class="col8 col8-sm col10-xs">
	          <div class="fl">
	              <input name="<@compId>_synch" id="<@compId>_synch_Y" type="radio" value="Y"><label for="day" class="ml5 lh33">동기</label>
	          </div>
	          <div class="fl">
	              <input name="<@compId>_synch" id="<@compId>_synch_N" type="radio" value="N"><label for="day" class="ml5 lh33">비동기</label>
	          </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</component>
