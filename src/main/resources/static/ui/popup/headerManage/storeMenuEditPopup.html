<meta charset="utf-8">
<script type="text/javascript">
	var <@popupId> = {
		 mainMenuList 	: []
		,storeMenuList 	: []
		,close : function(returnData) {
			C_POP.close({reload : "Y"});
		 }
		,setMappingMenu : function(brandMenuCd) {
			let gridInstance = <@popupId>.gridComp1.getGridInstance();
			let selectCells = gridInstance.getSelectedCells();
			let targetDom = selectCells[0];
			gridInstance.setCellToColumn(targetDom, brandMenuCd, "BRAND_MENU_CD");
		 }
		,menuAutoMapping : function() {
			
			const comprate = prompt("기준 유사율을 입력하세요 (50 ~ 100)");
			
			if(!isNumber(comprate)) {
				C_POP.alert('정확한 값을 입력 하세요.');
				return;
			}
			
			var parm = {
				 queryId 		: "common.getWordGrpList"
				,requestParm	: { BRAND_ID : G_VAL.session.BRAND_ID}
			}
			let resultData = C_COM.requestQuery(parm);
			let similarWordList = resultData.data;
			
			let gridInstance 	= <@popupId>.gridComp1.getGridInstance();
			let mainMenuList 	= <@popupId>.mainMenuList;
			let storeMenuList 	= <@popupId>.storeMenuList;
			let mainMenuMap		= arrayToMap(mainMenuList, "BRAND_MENU_CD");
			
			// 유사어 검색 대상에 포함.
			$.each(similarWordList, function() {
				let mainMenuObj = mainMenuMap[this.WORD_GRP_ID];
				let brandMenuCd = this.WORD_GRP_ID;
				let mainMenuNm 	= this.SIMILAR_WORD_NM;
				if(isEmpty(mainMenuObj)) mainMenuObj = {SELLING_PRICE : 0}			
				let item = {
					 "BRAND_MENU_CD" 	: brandMenuCd
					,"MENU_NM" 			: mainMenuNm
					,"SELLING_PRICE"	: mainMenuObj.SELLING_PRICE
				}
				mainMenuList.push(item);
			});
			$.each(storeMenuList, function() {
				let item = this;
				let storeMenuNm = item.MENU_NM;
				let smenu 		= {rate : 0, recipeRate : 100}
				$.each(mainMenuList, function() {
					let recipeRate = 100;
					if(this.SELLING_PRICE != 0) recipeRate = Math.round(item.SELLING_PRICE / this.SELLING_PRICE * 100);

					let mainMenuNm = this.MENU_NM;

					let rate = getSimilarity(storeMenuNm, mainMenuNm);
					if(isEmpty(smenu.rate)) {
						smenu = this;
						smenu.rate 			= rate;
						smenu.recipeRate 	= recipeRate;
					} else {
						if(smenu.rate <= rate) {
							smenu = this;
							smenu.rate 		= rate;
							smenu.recipeRate= recipeRate;
						}
					}
					if(rate >= 100) return false;
				});
				if(smenu.rate == 100) smenu.recipeRate = 100;
				if(smenu.rate >= comprate) {
					let mapData = {
						 STORE_ID 		: item	["STORE_ID"		]
						,MENU_ID		: item	["MENU_ID"		]
						,BRAND_MENU_CD	: smenu	["BRAND_MENU_CD"]
						,RECIPE_RATE	: smenu.recipeRate
					}
					gridInstance.setRowDataByPk(mapData);
				}
			});
			
		 }
	}
	// Popup Load가 완료된후 실행 된다.
	C_POP.onLoadPopup("<@popupId>", function(sendParm) {

		if(isEmpty(G_VAL.current.storeId)) {
			C_POP.alert('선택된 가맹점이 없습니다.');
			<@popupId>.close();
			return;
		}
		
		const storeNm = C_COM.getCurrentStoreName()
		
		let parmFst = {
			gridParm : {
				 requestQuery	: {
					  queryId		: "headerManage.getStoreMenuList"
					 ,requestParm	: {}
				 }
				,tableName		: "TBL_EXP_STORE_MENU_MST"
				,columnMap 		: {
					 "STORE_ID"         	: { headerText : "가맹점ID"		, hidden 		: "Y", default : G_VAL.current.storeId 	} 
					,"MENU_ID"          	: { headerText : "MENU_ID"		, hidden 		: "Y", ifNewAutoSet : "random"			 	} 
					,"MENU_CD" 				: { headerText : "메뉴CD"																} 
					,"MENU_NM"          	: { headerText : "메뉴명"       , align : "left", width : "200px"						} 
					,"SELLING_PRICE"    	: { headerText : "가격"			,dataType : "number"									} 
					,"RECIPE_RATE"			: { headerText : "Recipe Rate"	,dataType : "number"	,width : "100px"				} 
					,"BRAND_MENU_CD" 		: { headerText : "본사메뉴CD"	, align : "left", width : "180px"						} 
					,"BRAND_MENU_NM"    	: { headerText : "본사메뉴명"	, columnType	: "readOnly", noSave	: "Y", align : "left"}
					,"BRAND_SELLING_PRICE"	: { headerText : "판매가"		, columnType	: "readOnly", noSave	: "Y", 	dataType : "number"} 
				 }
				,headerTextGroup	: {
					"본사메뉴" : [
						 "BRAND_MENU_CD"
						,"BRAND_MENU_NM"
						,"BRAND_SELLING_PRICE"
					]
				 }
				,primaryKeyList		: ["STORE_ID"	, "MENU_ID"]
				,searchColumnList	: ["A.MENU_CD"	, "A.MENU_NM", "B.BRAND_MENU_CD", "B.MENU_NM"]
				,orderColumnList 	: ["A.MENU_NM"]
				,searchWhereMap		: {"C.BRAND_ID" : G_VAL.session.BRAND_ID, "A.STORE_ID" : G_VAL.current.storeId } 
				,columnConfig : {
					 onChangeCell : {
						"BRAND_MENU_CD"	: {
							func : function(gridInstance, rowIdx, colIdx, cellObj, rowData) {
								let gridComp2Instance = <@popupId>.gridComp2.getGridInstance();
								let selData = gridComp2Instance.getRowDataByPk(rowData);
								if(isEmpty(selData)) selData = {}
								let recipeRate = 100;
								if(isEmpty((selData.SELLING_PRICE))) recipeRate = "";
								else if(selData.SELLING_PRICE != 0) recipeRate = Math.round(rowData.SELLING_PRICE / selData.SELLING_PRICE * 100);
								gridInstance.setCellToColumn(cellObj, selData.MENU_NM 			,"BRAND_MENU_NM"		);
								gridInstance.setCellToColumn(cellObj, selData.SELLING_PRICE 	,"BRAND_SELLING_PRICE"	);
								gridInstance.setCellToColumn(cellObj, recipeRate 				,"RECIPE_RATE"			);
							}
						}
					 }
					,makeCellViewData	: {
						"RECIPE_RATE"	: function(cellText, rowData) {
							if(isValid(cellText)) 	return cellText + "%"; 
							else 					return cellText;
						}
					 }
				}
			 }
			,gridTitle : `가맹점 메뉴 ( ${storeNm} ) `
			,addButtonList : [
				{
					 title 		: "메뉴자동연결"
					,onClick	: function() {
						<@popupId>.menuAutoMapping();
					 }  
				}
			]
		}
		C_COMP.import("gridComp1", "component_compGridWithSearch",parmFst , function(tableList) {
			<@popupId>.storeMenuList = tableList;
		});		
		
		let parmSnd = {
			gridParm : {
				 tableName		: "TBL_EXP_BRAND_MENU_MASTER"
				,columnMap 		: {
					 "BRAND_MENU_CD" 		: { headerText : "메뉴CD" 	}
					,"MENU_NM"  			: { headerText : "메뉴명", align : "left", width : "150px"   }
					,"GROUP_1"      		: { headerText : "대분류"	,columnType 	: "selectbox", useBrandCodeId : "STORE_MENU_GROUP1", align : "left" 	}
					//,"GROUP_2"      		: { headerText : "중분류"	,columnType 	: "selectbox", useBrandCodeId : "STORE_MENU_GROUP2" 	}
					,"SELLING_PRICE"		: { headerText : "판매가"	,dataType 		: "number"												} 
				 }
				,columnConfig : {
				 }
				,rowConfig		: {
					onDblClickRow : function(rowObj) {
						<@popupId>.setMappingMenu(rowObj.BRAND_MENU_CD);
					}
				 }
				,primaryKeyList		: ["BRAND_MENU_CD"]
				,searchColumnList	: ["BRAND_MENU_CD", "MENU_NM"]
				,orderColumnList 	: ["MENU_NM"]	
				,searchWhereMap		: {"BRAND_ID" : G_VAL.session.BRAND_ID	}
				,readOnly			: "Y"
			}
			,gridTitle : "본사 메뉴"
		};
		C_COMP.import("gridComp2", "component_compGridWithSearch",parmSnd , function(tableList) {
			<@popupId>.mainMenuList = tableList;
		});		
	});
</script>
<!-- modal-popup start -->
<div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="full-modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <!-- header start -->
        <div class="modal-header srch-pop-inwrap">
          <h5 class="modal-title col9 col8-md col7-sm">가맹점 메뉴 연결</h5>
          <!-- button start -->
          <div class="txt-r col1 col2-md col3-sm">
            <button type="button" class="win-fullcls" style="display:none">
            </button>
            <button type="button" class="win-full" style="display:none">
            </button>
            <button type="button" class="close" aria-label="Close" onclick="<@popupId>.close()">
              <span class="pop-cls" aria-hidden="true"></span>
            </button>
          </div>
          <!-- button end -->
        </div>
        <!-- header end -->
  
        <!-- body start -->
        <div class="modal-body">
          <div class="body-inwrap display-row-nowrap-md"> <!-------------------- 테이블 좌, 우 배치 시 -- 이 부분에 클래스명 추가 ( display-row-nowrap-md ) // 테이블 하나의 경우 클래스명 추가 불필요 -------------------->

            <!-- table area start -->
            <div class="tb-card-allwrap col6 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">
						<!-- table start -->
						<compnent id="gridComp1"></compnent>    
						<!-- table end -->        
                    </div>
                </div>
            </div>
            <!-- table area end -->            

            <!-- table area start -->
            <div class="tb-card-allwrap col4 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">
						<!-- table start -->
						<compnent id="gridComp2"></compnent>    
						<!-- table end -->        
                    </div>
                </div>
            </div>
            <!-- table area end -->            

          </div>        
        </div>
        <!-- body end -->
  
        <!-- footer start -->
        <div class="modal-footer">
          <button type="button" class="btn outline-btn" onclick="C_COM.showHelp({helpType : 'POPUP', helpTitle : '가맹점 메뉴 연결'})">도움말</button>
          <button type="button" class="btn outline-btn mr20" onclick="<@popupId>.close()">Close</button>
        </div>
        <!-- footer end -->
      </div>
    </div>
</div>                      
<!-- modal-popup end -->
