<meta charset="utf-8">
<script type="text/javascript">
	var <@popupId> = {
		 sendParm				: {}
		,selectPretreatmentCd	: ""
		,grid1TableList			: []
		,grid1TableMap			: {}
		,grid3TableList			: []
		,grid3TableMap			: {}
		,preventCheckbox		: false
		,onClickRowPretreatment	: function(data) {
			<@popupId>.loadGrid2(data.PRETREATMENT_CD);
		 }
		,loadGrid1			: function(parm, callback) {
			////////////////////// 첫번째 그리드 ////////////////////////////////////
			
			let sendParm = {
				gridParm : {
					 tableName		: "TBL_EXP_PRETREATMENT_MST"
					,columnMap 		: {
						 "PRETREATMENT_CD"		: { headerText : "제조식품CD", readOnly : "Y"					}
						,"PRETREATMENT_NM"		: { headerText : "제조식품명" , readOnly : "Y"					}
						,"UNIT"					: { headerText : "단위", width	 : "80px"						}
						,"CONVERSION_UNIT_PRICE": { headerText : "단가", width	 : "80px", dataType : "number", fix : "2" 	}
					 }
					,primaryKeyList		: ["PRETREATMENT_CD"]
					,searchColumnList	: ["PRETREATMENT_CD", "PRETREATMENT_NM"]		// Table 지정인경우 적용
					,searchWhereMap		: {"BRAND_ID" : G_VAL.session.BRAND_ID }
					,orderColumnList 	: ["PRETREATMENT_CD"]							
					,columnConfig 	: {
						 onClickCell		: function(column, rowData) {
							if(in_array(column, ["PRETREATMENT_CD","PRETREATMENT_NM"])) {
								<@popupId>.onClickRowPretreatment(rowData);
							}
						 }
						,onChangeCell : {
							"CONVERSION_UNIT_PRICE"	: {
								func : function(gridObj, rowIdx, colIdx, cellObj, rowData) {
									
									const pretreatmentCd 	= rowData["PRETREATMENT_CD"];
									
									const newup				= rowData["CONVERSION_UNIT_PRICE"];
									
									const orgup				= <@popupId>.grid1TableMap[pretreatmentCd]["CONVERSION_UNIT_PRICE"];
									
									if(newup == orgup) 									$(cellObj).css("background", "");
									else												$(cellObj).css("background", "#FFEFEF");
								}
							}
						 }
					 }
					,updateOnly		: "Y"
				 }
				,gridTitle : "제조식품 Master"
				
			}
			
			C_COMP.import("gridComp1", "component_compGridWithSearch",sendParm , function(tableList) {
				<@popupId>.grid1TableList	= tableList;
				<@popupId>.grid1TableMap	= arrayToMap(tableList, "PRETREATMENT_CD");
				if( typeof callback == "function") callback(tableList);
			});		
			
		 }
		,setGrid1Unit		: function(gridObj, rowIdx, colIdx, cellObj, rowData) {
			let dataList = gridObj.getGridData();
			let totUnitPrice 	= 0;
			let totQtt 			= 0;
			 
			$.each(dataList, function() {
				let grid3RowData = <@popupId>.grid3TableMap[this.MATERIALS_CD];
				let up = nvl(grid3RowData.CONVERSION_UNIT_PRICE, 0) * nvl(this.QUANTITY, 0);
				totUnitPrice 	+= up
				totQtt			+= toNumber(this.QUANTITY);
			});
			 
			const fstGridInstance 	= <@popupId>.gridComp1.getGridInstance();
			
			const pretreatmentCd 	= <@popupId>.selectPretreatmentCd
			
			const cup				= toNumber(totUnitPrice / totQtt, 2); 
			
			let mapData = {
				 PRETREATMENT_CD 		: pretreatmentCd
				,CONVERSION_UNIT_PRICE	: cup
			}
			fstGridInstance.setRowDataByPk(mapData);
		 }
		,loadGrid2			: function(pretreatmentCd) {
			if(isValid(pretreatmentCd)) <@popupId>.selectPretreatmentCd = pretreatmentCd;
			
			const pretreatmentNm 	= <@popupId>.grid1TableMap[pretreatmentCd].PRETREATMENT_NM;
			
			const gridTitle			= `제조식품 구성 식자재 ( ${pretreatmentNm} )`;		
			
			////////////////////// 두번째 그리드 ////////////////////////////////////
			let sendParm2 = {
				gridParm : {
					 requestQuery 	: {
						  queryId		: "headerManage.getPretreatmentMaterialsList"
						 ,requestParm	: {}
					 }	
					,tableName		: "TBL_EXP_PRETREATMENT_MATERIALS"
					,columnMap 		: {
						 "PRETREATMENT_MATERIALS_ID" 	: { headerText : "RMID"			, hidden 	: "Y", ifNewAutoSet   : "Y"				}
						,"PRETREATMENT_CD" 				: { headerText : "제조식품CD"	, hidden 	: "Y", default		  :  pretreatmentCd	}
						,"MATERIALS_CD" 				: { headerText : "식자재CD" 														}
						,"MATERIALS_NM" 				: { headerText : "식자재명"		, columnType: "readOnly", noSave  : "Y"				}
						,"CONVERSION_UNIT_PRICE"		: { headerText : "단가" 		, columnType: "readOnly", width	 : "60px", dataType : "number", fix : "2"	}
						,"UNIT" 						: { headerText : "사용단위" 	, notNull 	: "Y"		, width	  : "80px"			}
						,"QUANTITY" 					: { headerText : "사용량"  		, dataType	: "number"	, notNull : "Y",fix : "2"	}
						,"CONVERSION_PRICE"				: { headerText : "원가"  		, dataType	: "number"	, notNull : "Y",fix : "2", noSave  : "Y"
															,initSetData : function(cellText, rowData) {
																const cup = rowData.CONVERSION_UNIT_PRICE;
																const qtt = rowData.QUANTITY;
																return nvl(cup * qtt, 0);
															 }
														  }
					 }
					,columnConfig 	: {
						 onChangeCell : {
							"MATERIALS_CD"	: {
								 func 		: function(gridObj, rowIdx, colIdx, cellObj, rowData) {
									let cellValue 	= rowData["MATERIALS_CD"];
									
									let grid3RowData		= <@popupId>.grid3TableMap[cellValue];
										
									if(isValid(rowData)) {
										gridObj.setCellToColumn(cellObj, grid3RowData.MATERIALS_NM			, "MATERIALS_NM"			);
										gridObj.setCellToColumn(cellObj, grid3RowData.CONVERSION_UNIT_PRICE	, "CONVERSION_UNIT_PRICE"	);
										gridObj.setCellToColumn(cellObj, grid3RowData.UNIT					, "UNIT"					);
										<@popupId>.setGrid3Checkbox();
									}
								 }						
							 }
							,"QUANTITY"	: { 
								func 		: function(gridObj, rowIdx, colIdx, cellObj, rowData) {
									
									<@popupId>.setGrid1Unit(gridObj, rowIdx, colIdx, cellObj, rowData);
									
									const cup = rowData.CONVERSION_UNIT_PRICE;
									const qtt = rowData.QUANTITY;
									const result =  nvl(cup * qtt, 0);
									
									gridObj.setCellToColumn(cellObj, result, "CONVERSION_PRICE");
								}				
							 }		
							,"CONVERSION_PRICE" : {
								func : function(gridObj, rowIdx, colIdx, cellObj, rowData) {
									compGrid2 = <@popupId>.gridComp2.getCompGrid();
									
									compGrid2.refreshBottomRow();
								}
							}
								
						 }
					 }
					,rowConfig : {
						onDeleteRow : function(rowDom, rowData) {
							<@popupId>.setGrid3Checkbox();
							
							compGrid2 = <@popupId>.gridComp2.getCompGrid();
							
							compGrid2.refreshBottomRow();
						}
					 }
					,primaryKeyList		: ["PRETREATMENT_MATERIALS_ID"]
					,searchColumnList	: ["A.PRETREATMENT_CD", "PRETREATMENT_NM", "MATERIALS_CD", "MATERIALS_NM"]		// Table 지정인경우 적용
					,searchWhereMap		: {"A.BRAND_ID" : G_VAL.session.BRAND_ID, "A.PRETREATMENT_CD" : <@popupId>.selectPretreatmentCd }
					,orderColumnList 	: ["A.PRETREATMENT_CD"]							
					,onLoad				: function(tableList) {
						<@popupId>.setGrid3Checkbox();
					 }
					,addBottomRow	: {
						 title		  	: "<b>합계</b>"
						,targetColumn 	: ["QUANTITY", "CONVERSION_PRICE"]
						,baseType		: "SUM"
					 }
					
				 }
				,gridTitle : gridTitle
			}
			
			C_COMP.import("gridComp2", "component_compGridWithSearch",sendParm2 , function(tableList) {
				
			});		
		 }
		,loadGrid3			: function() {
			////////////////////// 세번째 그리드 ////////////////////////////////////
			let gridParm = {
				 tableName		: "TBL_EXP_FOOD_MATERIALS_MASTER"
				,columnMap 		: {
					 "MATERIALS_MASTER_ID" 			: { headerText : "MATERIALS_ID"	, hidden : "Y"							}
					,"MATERIALS_CD"        			: { headerText : "식자재CD"  	, width	 : "120px"						}
					,"MATERIALS_NM"        			: { headerText : "식자재명"  											}
					,"UNIT" 		       			: { headerText : "사용단위"		, width	 : "80px"						}
					,"CONVERSION_UNIT_PRICE"		: { headerText : "단가" 		, width	 : "60px", dataType : "number", fix : "2"	}
				 }
				,columnConfig 	: {
				 }
				,rowConfig		: {
					onChangeCheckBoxState : function(state, rowData) {

						let grid2Object = <@popupId>["gridComp2"].getGridInstance();

						if(state) {
							// Grid2에 Row 삽입
							rowData.PRETREATMENT_CD = <@popupId>.selectPretreatmentCd;
							
							grid2Object.addNewRow(rowData);
						} else {
							// Grid2에 해당Row 삭제
							let parm = {
								searchList : [
									{ column : "MATERIALS_CD", searchVal : rowData.MATERIALS_CD }
								]
							}
							let tdCellList = grid2Object.searchCellList(parm);
							
							if(isValid(tdCellList)) {
								grid2Object.deleteRow(tdCellList);	
							}
						}
						let cnt = <@popupId>["gridComp2"].refreshTotalCnt();
					 }
					,onChangeAllCheckBoxState : function(checked) {
						
						let grid2Object = <@popupId>["gridComp2"].getGridInstance();
						let grid3Object = <@popupId>["gridComp3"].getGridInstance();
						
						<@popupId>["gridComp2"].clearGrid();

						if(checked) {
							// Grid2에 해당Row 삭제
							let parm = {
								 searchList : [
									{ column : "MATERIALS_CD"}
								 ]
								,searchType : "ALL"
							}
							
							let rowDataList = C_GRID.getGridData(grid3Object.gridId);
							
							<@popupId>.preventCheckbox = true;
							
							$.each(rowDataList, function() {
								let rowData = this;
								
								// Grid2에 Row 삽입
								rowData.PRETREATMENT_CD = <@popupId>.selectPretreatmentCd;
								
								grid2Object.addNewRow(rowData);
								
							});
							
							<@popupId>.preventCheckbox = false;
							
						} else {
							
						}
					 }
				 }
				,rowCntId			: "<@popupId>_rowCnt3"
				,primaryKeyList		: ["MATERIALS_MASTER_ID"]
				,searchColumnList	: ["MATERIALS_CD", "MATERIALS_NM"]				
				,orderColumnList 	: ["SORT_ORDER ASC"]							
				,searchWhereMap		: { BRAND_ID : G_VAL.session.BRAND_ID } 
				,checkbox			: "show"
				,allCheckHide		: "Y"
				//,ordernum			: "hide"
				,readOnly			: "Y"
				,onLoad				: function(tableList) {
					<@popupId>.setGrid3Checkbox();	
				 }
			}

			C_COMP.import("gridComp3", "component_compGrid",{ gridParm : gridParm } , function(tableList) {
				<@popupId>.grid3TableList	= tableList;
				<@popupId>.grid3TableMap	= arrayToMap(tableList, "MATERIALS_CD");
			});		
		 }
		,reloadGrid3 : function() {
			let searchValue = $("#<@popupId> #searchValue").val();
			<@popupId>["gridComp3"].reload({searchValue : searchValue});
		 }
		,setGrid3Checkbox : function() {
			// Grid2 Data
			let grid2TableList = <@popupId>["gridComp2"].getGridData("view");
			let grid3Instance  = <@popupId>["gridComp3"].getGridInstance();
			
			if(isEmpty(grid2TableList) || isEmpty(grid3Instance)) return;
			
			grid3Instance.setAllCheckBox(false);
			
			$.each(grid2TableList, function() {
				let parm = {
					searchList : [
						{
							 column 		: "MATERIALS_CD"
							,searchVal	: this.MATERIALS_CD 
						}
					]
				}
				let tdCellList = grid3Instance.searchCellList(parm);
				$.each(tdCellList, function() {
					grid3Instance.setCheckBox(this, true);	
				});
			});
		 }
		,close : function(returnData) {
			if(isEmpty(returnData)) returnData = {};
			C_POP.close({reload : "Y"});
		 }
		
	}
	// Popup Load가 완료된후 실행 된다.
	C_POP.onLoadPopup("<@popupId>", function(parm) {
		
		<@popupId>.loadGrid1(parm, function(tableList) {
			
			let pretreatmentCd = tableList[0].PRETREATMENT_CD;
			
			<@popupId>.loadGrid2(pretreatmentCd);

			<@popupId>.loadGrid3();
		});
		
	});
</script>
<!-- modal-popup start -->
<div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="full-modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <!-- header start -->
        <div class="modal-header srch-pop-inwrap">
          <h5 class="modal-title col9 col8-md col7-sm">제조식품 구성 편집</h5>
          <!-- button start -->
          <div class="txt-r col1 col2-md col3-sm">
            <button type="button" class="win-fullcls" style="display:none">
            </button>
            <button type="button" class="win-full" style="display:none">
            </button>
            <button type="button" class="close" aria-label="Close" onclick="<@popupId>.close()">
              <span class="pop-cls" aria-hidden="true"></span>
            </button>
          </div>
          <!-- button end -->
        </div>
        <!-- header end -->
  
        <!-- body start -->
        <div class="modal-body">
          <div class="body-inwrap display-row-nowrap-md"> <!-------------------- 테이블 좌, 우 배치 시 -- 이 부분에 클래스명 추가 ( display-row-nowrap-md ) // 테이블 하나의 경우 클래스명 추가 불필요 -------------------->

            <!-- table area start -->
            <div class="tb-card-allwrap col3 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">
						<!-- table start -->
						<compnent id="gridComp1"></compnent>    
						<!-- table end -->        
                    </div>
                </div>
            </div>
            <!-- table area end -->            

            <!-- table area start -->
            <div class="tb-card-allwrap col4 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">
						<!-- table start -->
						<compnent id="gridComp2"></compnent>    
						<!-- table end -->        
                    </div>
                </div>
            </div>
            <!-- table area end -->            

            <!-- table area start -->
            <div class="tb-card-allwrap col3 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">
					    <!-- table area start -->
						<div class="table-allwrap display-column"> <!-------------------- 이 부분에 클래스명 추가 ( display-column ) -------------------->
						    <div class="card-tit-wrap">
						        <div class="card-tit">식자재 선택</div>
						    </div>
						    <div class="display-between display-sm-between deco-line pt10 pl10 pr10 pb5">
						        <div class="col4-md col10-sm display-h-end mb5">
						          <span class="col2-sm w80px mb3">검색어</span>
						          <input type="text" class="form-control form-control-sm mr5 col4" id="searchValue" onEnter="<@popupId>.reloadGrid3()">
						          <button class="srch-btn" type="button" onclick="<@popupId>.reloadGrid3()">검 색</button>       
						        </div>
						        <div class="display-w-end col4 col4-md col10-sm mb5">
						          <span class="col2-sm w120px txt-r mr10">Total : <span class="txt-red" id="<@popupId>_rowCnt3"></span></span>              
						        </div>
						    </div>
						    <div class="table-inwrap-scroll"> <!-------------------- 이 부분에 div + 클래스명 추가 ( table-inwrap-scroll ) -------------------->
								<!-- table start -->
								<compnent id="gridComp3"></compnent>    
								<!-- table end -->        
						    </div>
						</div>
					    <!-- table area end -->
                    </div>
                </div>
            </div>
            <!-- table area end -->            


          </div>        
        </div>
        <!-- body end -->
  
        <!-- footer start -->
        <div class="modal-footer">
          <button type="button" class="btn outline-btn" onclick="C_COM.showHelp({helpType : 'POPUP', helpTitle : '제조식품 구성 편집'})">도움말</button>
          <button type="button" class="btn outline-btn mr20" onclick="<@popupId>.close()">Close</button>
        </div>
        <!-- footer end -->
      </div>
    </div>
</div>                      
  <!-- modal-popup end -->
