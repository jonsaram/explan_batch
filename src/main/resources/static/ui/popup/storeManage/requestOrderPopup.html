<meta charset="utf-8">
<script type="text/javascript">
	var <@popupId> = {
		 storeId	: ""
		,coffeeForOne : 20
		,prdInfoMap	: {}
		,orderMap	: {}
		,orderList	: []
		,sendParm	: {}
		,makeOrder	: function(rowData, buyCnt) {
			
			if(isEmpty(buyCnt)) buyCnt = 1;
			
			if(isEmpty(rowData.BASE_PRODUCT_CD)) {
				rowData.BASE_PRODUCT_CD = <@popupId>.prdInfoMap[rowData.PRODUCT_CD].BASE_PRODUCT_CD
				rowData.BASE_PRODUCT_NM = <@popupId>.prdInfoMap[rowData.PRODUCT_CD].BASE_PRODUCT_NM
			}
			let orderKey = rowData.PRODUCT_CD;

			let orderMap = <@popupId>.orderMap;
			
			if(isValid(orderMap[orderKey])) {
				let item = orderMap[orderKey];
				if(buyCnt == 1)	item.orderCnt++;
				else			item.orderCnt = buyCnt;
			} else {
				let item = fn_copyObject(rowData);
				item.orderCnt = buyCnt;
				orderMap[orderKey] = item;
			}
			<@popupId>.orderMap = orderMap;
		 }
		,reloadOrder : function() {
			
			let orderMap = <@popupId>.orderMap;
			
			let orderList = []
			
			let baseProductInfo = {}
			
			$.each(orderMap, function(key, obj) {
				if(isEmpty(baseProductInfo[obj.BASE_PRODUCT_CD])) baseProductInfo[obj.BASE_PRODUCT_CD] = { restQtt : 0, buyQtt : 0 }
				
				baseProductInfo[obj.BASE_PRODUCT_CD].buyQtt += obj.CONVERSION_QUANTITY * obj.orderCnt;
				
				orderList.push(obj); 
			});
			let priceSum = 0;
			$.each(orderList, function(idx) {
				orderList[idx].buyQtt 	= baseProductInfo[this.BASE_PRODUCT_CD].buyQtt;
				orderList[idx].restQtt 	= Number(this.NEED_QUANTITY) + Number(baseProductInfo[this.BASE_PRODUCT_CD].buyQtt);
				
				priceSum += orderList[idx].UNIT_PRICE * orderList[idx].orderCnt;
			});

			$("#<@popupId>_rowCnt").html(orderList.length);
			
			orderList.orderBy("BASE_PRODUCT_CD");
			
			<@popupId>.orderList = orderList;
			
			var rparm = {
				 targetId 	: "<@popupId>_orderTable"
				,list		: orderList	
			}
			C_COM.renderHtml("<@popupId>", rparm);
			mergeTableTD("<@popupId>_orderTable", {startIdx : 7, endIdx : 9, startRowIdx : 1});
			
			let tdStr = ""
			if(orderList.length > 0) {
				tdStr = `<tr><td colspan=5>총금액</td><td title="${addComma(priceSum)}">${addComma(priceSum)}</td><td colspan=4></td>`;
			}

			$("#<@popupId>_orderTable").append(tdStr);
			
		 }
		,changeOrder : function(productId, val) {
			let orderMap = <@popupId>.orderMap;
			
			<@popupId>.orderMap[productId].orderCnt = val;
			
			<@popupId>.reloadOrder();			
			
		 }
		,close : function(returnData) {
			if(isEmpty(returnData)) returnData = {};
			C_POP.close(returnData);
		 }
		,initSetDataNq : function(cellText, rowData) {
			
			let retStr = rowData.nujukSumQt - rowData.AVG_QUANTITY;
			
			if(!isNumber(retStr)) retStr = "";
			
			return retStr;
		 }
		,deleteRow : function(productCd) {
			delete <@popupId>.orderMap[productCd];
			<@popupId>.reloadOrder();			
		 }
		,requestOrder : function() {
			
			if(isEmpty(<@popupId>.orderList) || <@popupId>.orderList.length == 0) {
				C_POP.alert('주문 요청 내역이 없습니다.');
				
				return;
			}

			C_POP.confirm('주문 요청 하시겠습니까?', function() {
				let orderId = C_COM.makeUniqueId();
				let queryGroup = []; 
			    let orderMst = {
					 ORDER_ID 	: orderId
					,STORE_ID 	: <@popupId>.storeId
					,STATE		: "RQST"
				}
				var parm = {
					 queryId 		: "storeManage.insertOrderMst"
					,requestParm	: orderMst
				}
			    queryGroup.push(parm);
			    
			    let orderProductList = [];
			    $.each(<@popupId>.orderList, function() {
			    	let item = {
			    		 ORDER_ID 	: orderId
			    		,PRODUCT_CD : this.PRODUCT_CD
			    		,ORDER_CNT	: this.orderCnt
			    	}
			    	orderProductList.push(item);
			    });
				var parm2 = {
					 queryId 			: "storeManage.insertOrderProduct"
					,requestParmList	: orderProductList
				}
			    
			    queryGroup.push(parm2);
				
				C_COM.requestQuery({queryGroup : queryGroup}, function(resultData) {
					C_POP.alert('주문 요청 되었습니다.\n\n주문내역은 주문 요청 관리 메뉴에서 확인 할 수 있습니다.');
					
					<@popupId>.orderMap 	= {}
					<@popupId>.orderList 	= []
					
					<@popupId>.reloadOrder();
				});
			});
		 }
		,autoSetting : function() {
			let coffeeQtt = 0
			dalert(<@popupId>.orderList);
			$.each(<@popupId>.orderList, function() {
				if(this.PRODUCT_CLASS == "01") { // 01은 커피
					coffeeQtt += this.CONVERSION_QUANTITY * this.orderCnt;					
				}				
			});
			
			if(coffeeQtt == 0) {
				C_POP.alert('커피 주문 내역이 없습니다.');
				return;
			}
			
			
			let minCnt = Math.ceil(coffeeQtt / <@popupId>.coffeeForOne)
			
			C_POP.confirm(`주문 커피량이 ${coffeeQtt}g 이고, 커피 1잔에 ${<@popupId>.coffeeForOne}g이 사용된다고 가정하면\n\n관련 부자재는 최소 ${minCnt}개가 필요합니다. 각 기자재는 묶음 단위로 계산되어 최소 묶음으로 주문 됩니다.\n\n기존에 추가한 부자재가 있다면, 삭제 됩니다.\n\n계속 진행 하시겠습니까?`
			, function() {
				let rowList = <@popupId>.<@popupId>_editor.getGridData();
				$.each(rowList, function() {
					if(this.PRODUCT_CLASS == "11") { // 11은 부자재
						let buyCnt = Math.ceil(coffeeQtt / <@popupId>.coffeeForOne / this.CONVERSION_QUANTITY);
						<@popupId>.makeOrder(this, buyCnt);
					}
				});
				<@popupId>.reloadOrder();
			});
			
		 }
		,init : function(tableDataList) {
			////////////////////// 첫번째 그리드 ////////////////////////////////////
			
			let sendParm = {
				gridParm : {
					 tableDataList	: tableDataList
					,columnMap 		: {
						 "BASE_PRODUCT_CD"		: { headerText : "상품코드" , hidden 	: "Y"		}
						,"BASE_PRODUCT_NM"		: { headerText : "상품명"  	, width		: "160px"	}
						,"UNIT"    				: { headerText : "단위"		, hidden 	: "Y"		}
						,"AVG_QUANTITY" 		: { headerText : "적정재고량",dataType 	: "number"	}
						,"nujukSumQt" 			: { headerText : "현재재고량",dataType 	: "number"	}
						,"STOCK_RATE"   		: { headerText : "재고율" 							}
						,"NEED_QUANTITY"		: { headerText : "부족량"	,initSetData : <@popupId>.initSetDataNq }
						,"PRODUCT_CD"   		: { headerText : "제품CD" 	, width		: "160px"	}
						,"PRODUCT_NM"   		: { headerText : "제품명"   , width		: "170px"	}
						,"UNIT_PRICE"			: { headerText : "가격" 	, hidden 	: "Y"		}
						,"CONVERSION_QUANTITY"	: { headerText : "용량" 	, hidden 	: "Y"		}
						,"PRODUCT_CLASS"		: { headerText : "분류" 	, hidden 	: "Y"		}
					 }
					,columnConfig		: {
						makeCellViewData	: {
							"STOCK_RATE"	: function(cellText, rowData) {
								if(isNumber(cellText)) 	cellText = cellText + "%";
								else					cellText = "";
								return cellText;
							 }
							,"AVG_QUANTITY"		: function(cellText, rowData) {
								return `${cellText} ${rowData.UNIT}`;
							 }
							,"NEED_QUANTITY"	: function(cellText, rowData) {
								return `${cellText} ${rowData.UNIT}`;
							 }
						 }
						,onDblClickCell : function(columnId, rowData) {
							<@popupId>.makeOrder(rowData)
							<@popupId>.reloadOrder();
							
						 }
					 }
					,primaryKeyList		: ["PRODUCT_CD"]
					,searchColumnList	: ["PRODUCT_CD", "PRODUCT_NM"]	
					,orderColumnList 	: ["B.PRODUCT_CD"	, "C.PRODUCT_CD"]				
					,searchWhereMap		: {"A.BRAND_ID" : G_VAL.session.BRAND_ID, "A.STORE_ID" : G_VAL.current.storeId }
					,cellMergeList		: [["BASE_PRODUCT_NM", "NEED_QUANTITY"]]
					,readOnly			: "Y"
					
				 }
				,gridTitle : "주문 제품 목록"
			}
			C_COMP.import("<@popupId>_editor", "component_compGridWithSearch",sendParm , function(tableList) {
				let prdInfoMap = arrayToMap(tableList, "PRODUCT_CD");
				<@popupId>.prdInfoMap = prdInfoMap;
			});
			
			var rparm = {
				 targetId 	: "<@popupId>_orderTable"
				,list		: []		
			}
			C_COM.renderHtml("<@popupId>", rparm);
			
		}
	}
	// Popup Load가 완료된후 실행 된다.
	C_POP.onLoadPopup("<@popupId>", function(parm) {
		
		<@popupId>.storeId = G_VAL.current.storeId;
		let stockMap	= arrayToMap(parm.stockList, "PRODUCT_CD");
		dwrite(stockMap);
		var parm = {
			 queryId 		: "storeManage.getOrderProductList"
			,requestParm	: { BRAND_ID : G_VAL.session.BRAND_ID }
		}
        C_COM.requestQuery(parm, function(resultData) {
        	let tList = resultData.data;
        	let tableDataList = []
        	$.each(tList, function() {
        		let stockItem = stockMap[this.BASE_PRODUCT_CD];
        		let newItem = $.extend({}, stockItem, this);
        		tableDataList.push(newItem);
        	});
        	<@popupId>.init(tableDataList);
        });
	});
</script>
<!-- modal-popup start -->
<div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="full-modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <!-- header start -->
        <div class="modal-header srch-pop-inwrap">
          <h5 class="modal-title col9 col8-md col7-sm">주문 요청</h5>
          <!-- button start -->
          <div class="txt-r col1 col2-md col3-sm">
            <button type="button" class="win-fullcls">
            </button>
            <button type="button" class="win-full">
            </button>
            <button type="button" class="close" aria-label="Close" onclick="<@popupId>.close()">
              <span class="pop-cls" aria-hidden="true"></span>
            </button>
          </div>
          <!-- button end -->
        </div>
        <!-- header end -->
  
        <!-- body start -->
        <div class="modal-body">
          <div class="body-inwrap display-row-nowrap-md"> <!-------------------- 테이블 좌, 우 배치 시 -- 이 부분에 클래스명 추가 ( display-row-nowrap-md ) // 테이블 하나의 경우 클래스명 추가 불필요 -------------------->

            <!-- table area start -->
            <div class="tb-card-allwrap col5 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">
						<!-- table start -->
						<compnent id="<@popupId>_editor"></compnent>    
						<!-- table end -->        
                    </div>
                </div>
            </div>
            <!-- table area end -->            

            <!-- table area start -->
            <div class="tb-card-allwrap col5 col10-md col10-sm mt10">
                <div class="card-inwrap">
                    <div id="tb-scroll" class="card-cnt-wrap">

					    <!-- table area start -->
						<div class="table-allwrap display-column"> <!-------------------- 이 부분에 클래스명 추가 ( display-column ) -------------------->
						    <div class="card-tit-wrap" id="grdtitle">
						        <div class="card-tit">주문 요청 목록</div>
						    </div>
						    <div class="display-between display-sm-between deco-line pt10 pl10 pr10 pb5">
						        <div class="col4-md col10-sm display-h-end mb5">
						        </div>
						        <div class="display-w-end col4 col4-md col10-sm mb5 mt10">
						          <span class="col2-sm w120px txt-r mr10 mb5">Total : <span class="txt-red" id="<@popupId>_rowCnt">0</span></span>
								  &nbsp;&nbsp;
								  <button class="flat-btn col2-sm" type="button" onclick="<@popupId>.autoSetting()">부자재 자동주문</button>
								  &nbsp;&nbsp;
								  <button class="flat-btn col2-sm" type="button" onclick="<@popupId>.requestOrder()">주문요청</button>
						        </div>
						    </div>
						    
						    <div class="table-inwrap-scroll"> <!-------------------- 이 부분에 div + 클래스명 추가 ( table-inwrap-scroll ) -------------------->
			                  <!-- table start -->
			                  <table class="table-inwrap">
			                    <colgroup>
			                      <col width="*">
			                      <col width="*">                    
			                      <col width="70px">
			                      <col width="70px">
			                      <col width="50px">                    
			                      <col width="100px">                    
			                      <col width="150px">
			                      <col width="70px">
			                      <col width="90px">
			                      <col width="30px">                    
			                    </colgroup>
			                    <thead class="table-thead">
			                      <tr>
			                        <th scope="col">제품CD</th>
			                        <th scope="col">제품명</th>
			                        <th scope="col">단가</th>
			                        <th scope="col">용량</th>
			                        <th scope="col">수량</th>
			                        <th scope="col">금액</th>
			                        <th scope="col">재고상품명</th>
			                        <th scope="col">구매량</th>
			                        <th scope="col">부족량</th>
			                        <th scope="col"></th>
			                      </tr>
			                    </thead>
			                    <tbody id="<@popupId>_orderTable">
			                    </tbody>
			                    
								<script type="text/x-jsrender" id="<@popupId>_orderTable_template">
									{{for list}}
				                      <tr>
				                        <td title="{{:PRODUCT_CD}}"					>{{:PRODUCT_CD}}				</td>
				                        <td title="{{:PRODUCT_NM}}"					>{{:PRODUCT_NM}}				</td>
				                        <td title="{{numb:UNIT_PRICE)}}"			>{{numb:UNIT_PRICE)}}			</td>
				                        <td title="{{numb:CONVERSION_QUANTITY}}"	>{{numb:CONVERSION_QUANTITY}}	</td>
				                        <td 										><input type="text" class="form-control form-control-sm col10" style="padding:0" value="{{:orderCnt}}" onChange="<@popupId>.changeOrder('{{:PRODUCT_CD}}', this.value)" number/></td>                      
				                        <td title="{{numb:UNIT_PRICE * orderCnt}}"	>{{numb:UNIT_PRICE * orderCnt}}	</td>                      
				                        <td title="{{:BASE_PRODUCT_NM}}"			>{{:BASE_PRODUCT_NM}}			</td>
				                        <td title="{{numb:buyQtt}}"					>{{numb:buyQtt}}				</td>
				                        <td title="{{numb:restQtt}}"				>{{numb:restQtt}}				</td>
				                        <td onclick="<@popupId>.deleteRow('{{:PRODUCT_CD}}')">x</td>                      
				                      </tr>
				                    {{/for}}
								</script>	
								<script type="text/x-jsrender" id="<@popupId>_orderTable_noData_template">
				                      <tr>
				                        <td colspan="10">주문 내역이 없습니다.</td>
				                      </tr>
								</script>	
			                  </table>
			                  <!-- table end -->
						    </div>
						</div>
					    <!-- table area end -->
                    </div>
                </div>
            </div>
            <!-- table area end -->            

          </div>        
        </div>
        <!-- body end -->
  
        <!-- footer start -->
        <div class="modal-footer">
          <button type="button" class="btn outline-btn mr20" onclick="<@popupId>.close()">Close</button>
        </div>
        <!-- footer end -->
      </div>
    </div>
</div>                      
<!-- modal-popup end -->
