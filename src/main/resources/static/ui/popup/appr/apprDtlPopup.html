<meta charset="utf-8">
<script type="text/javascript">
	var <@popupId> = {
	 requestParm 	: {}
	,apprData	 	: {}
	,apprMemberData : {}
    ,searchApprovalDtl : function(requestParm){

        let parm = {
             queryId        : "approval.getApproval"
            ,requestParm    : requestParm
        }
        C_COM.requestQuery(parm, function(resultData) {
			
            $('#<@popupId> #USER_NM'		).html(resultData.data[0].USER_NM);
            $('#<@popupId> #APPROVAL_DATE'	).html(resultData.data[0].APPROVAL_DATE);
            $('#<@popupId> #APPROVAL_TITLE'	).html(resultData.data[0].TITLE);
            $('#<@popupId> #CONTENTS'		).html(resultData.data[0].CONTENTS + "<br/>");

            <@popupId>.apprData = resultData.data[0];

            if(<@popupId>.apprData.STATE == "ONGOING" && <@popupId>.apprData.USER_ID == G_VAL.session.USER_ID) $("#<@popupId>_cancelappr").show();
        });

        /* 결재자 조회*/
        let parmDtl = {
             queryId        : "approval.getApprovalUser"
            ,requestParm    : requestParm
        }
        
        C_COM.requestQuery(parmDtl, function(resultData) {
        	
        	<@popupId>. apprMemberData = resultData.data;
        	let statefstNullCheck = "N";
        	$.each(resultData.data, function(idx) {
        		if(this.APPROVAL_TYPE == "RQST") {
        			resultData.data[idx].apprTypeStr = `<span class="stateBtn drafter wauto">${this.APPROVAL_TYPE_NM}</span>`;
        			
        		} else {
        			resultData.data[idx].apprTypeStr = `<span class="stateBtn toggle active">${this.APPROVAL_TYPE_NM}</span>`;
        		}
        		
        		if(this.APPROVAL_TYPE == "RQST") {// 상신자 이면 
        			resultData.data[idx].stateStr = `<span class="status-ing">결재상신</span>`;
        		} else if(isEmpty(this.STATE) && statefstNullCheck == "N" && this.APPROVAL_TYPE != "NOTICE") {
        			//상신자가 아니고, 통보도아님( )
        			resultData.data[idx].stateStr = `<span class="status-ing">결재진행</span>`;
        			statefstNullCheck = "Y";
        		} else if(isValid(this.STATE)) {
        			resultData.data[idx].stateStr = `<span class="status-complete">${this.STATE_STR}</span>`;
        		}
        	});
        	
            let rparmDtl = {
                 targetId   : "tableId"
                ,list       : resultData.data
            }
            C_COM.renderHtml("<@popupId>", rparmDtl);
        });
     }
/*
    ,reAppr : function() {
    	
    	let parm 			= <@popupId>.apprData;
    	parm.apprMemberData = <@popupId>.apprMemberData;
    	parm.reApprYn		= "Y"

        C_POP.open('popup_appr_apprReqPopup', parm, function() {
            //<@popupId>.close();
        });
     }
*/	     
	,cancelAppr : function() {
		let apprInfo 			= <@popupId>.apprData;
		C_POP.confirm('결재상신을 취소 하시겠습니까?', function() {
	        let parm = {
                queryId        : "approval.saveResultAppr"
               ,requestParm    : {
            	   	 APPROVAL_ID 		: apprInfo.APPROVAL_ID
            	   	,APPROVAL_COMMENT 	: ""
            	   	,STATE				: 'CANCEL'
            	}
        	}
        	let parmSnd = {
                queryId        : "approval.saveResultMainAppr"
               ,requestParm    : {
               	   	 APPROVAL_ID	: apprInfo.APPROVAL_ID
               	   	,STATE			: 'CANCEL' 
               	}
        	}
        	lastParm = {
        		queryGroup : [
        			 parm
        			,parmSnd
        		]
        	}
	        
			C_COM.requestQuery(lastParm, function(resultData) {
				if( resultData.state == "S"){
					
					// 결재 취소 후 처리 
		            var parm = {
		                 serviceId              : "ApprovalService.approvalAfterProcess"
		                ,requestParm            : {APPROVAL_ID : apprInfo.APPROVAL_ID}
		            }
		            C_COM.requestService(parm, function(resultData) {
						C_POP.alert('결재상신이 취소 되었습니다.');
						<@popupId>.close('reload');
		            });
				}else{
					alert(resultData.msg)
				}
			});				
			
		});
	 }
	,close : function(returnData) {
		if(isEmpty(returnData)) returnData = {};
		C_POP.close(returnData);
	 }
	
	}
	
	// Popup Load가 완료된후 실행 된다.
	C_POP.onLoadPopup("<@popupId>", function(data) {
        <@popupId>.searchApprovalDtl(data);
   		// 첨부파일 컴포넌트 추가
       	var parm = {
   			 GRP_FILE_ID 	: data.APPROVAL_ID
   			,OWNER_CD 		: "APPROVAL"
   			,mode			: "R"
   			,title			: "NA"
   		}
   		C_COMP.import("<@popupId>_appFileMng", "component_compMultiFilemng", parm , function() {
		});
	});
</script>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<!-- header start -->
			<div class="modal-header srch-pop-inwrap">
				<h5 class="modal-title col9 col8-md col7-sm">결재 상세</h5>
				<!-- button start -->
				<div class="txt-r col1 col2-md col3-sm">
					<button type="button" class="close" aria-label="Close" onclick="<@popupId>.close()">
						<span class="pop-cls" aria-hidden="true"></span>
					</button>
				</div>
				<!-- button end -->
			</div>
			<!-- header end -->

			<div class="modal-body">

		       <div class="body-inwrap">
		
		            <!-- 결재 상신 내용 start -->
		            <div class="display-between">
		                <div class="card-tit">결제 상신 내용</div>
		            </div>
		            <!-- table area start -->
		            <div class="tb-card-allwrap03 col10">
		                <div class="card-inwrap">
		                    <div id="tb-scroll" class="card-cnt-wrap">
		                        <!-- table start -->
		                        <table class="tb-wr-wrap tb-read-wrap col10 col10-xs">
		                            <colgroup>
		                                <col>
		                                <col>
		                            </colgroup>
		                            <tbody>
		                                <tr>
		                                    <th class="col1 col1-md col2-sm col2-xs">상신자</th>
		                                    <td class="col4 col4-md col8-sm col8-xs"  id="USER_NM"></td>
		                                    <th class="col1 col1-md col2-sm col2-xs">상신일</th>
		                                    <td class="col4 col4-md col8-sm col8-xs" id="APPROVAL_DATE"></td>                          
		                                </tr>
		                                <tr colspan="4">
		                                    <th class="col1 col2-sm col10-xs">제 목</th>
		                                    <td colspan="3" class="col9 col8-sm col10-xs" id="APPROVAL_TITLE" ></td>
		                                </tr>                        
		                                <tr colspan="4">
		                                    <th class="col1 col2-sm col10-xs th-110">상신 내용</th>
		                                    <td colspan="3" class="col9 col8-sm col10-xs">
		                                        <div style="max-height:150px;overflow:auto;" id="CONTENTS">
		                                        </div>
		                                    </td>
		                                </tr>
		                                <tr colspan="4">
		                                    <th class="col1 col2-sm col10-xs">첨부 파일</th>
		                                    <td colspan="3" class="col9 col8-sm col10-xs">
		                                        <compnent id="<@popupId>_appFileMng"></compnent>  
		                                    </td>
		                                </tr>                                                                                                      
		                            </tbody>
		                            </table>
		                        <!-- table end -->
		                    </div>
		                </div>
		            </div>
		            <!-- table area end -->
		            <!-- 결재 상신 내용 end -->
		
		            <!-- 결재 진행 내용 start -->
		            <div class="display-between">
		                <div class="card-tit">결재 진행 내용</div>
		            </div>
		            <!-- table area start -->
		            <div class="tb-card-allwrap col10 mt10">
		                <div class="card-inwrap">
		                  <div id="tb-scroll" class="card-cnt-wrap">
		                    <div class="table-allwrap ">
		                      <!-- table start -->
		                      <table class="table-inwrap">
		                        <colgroup>
		                          <col width="150px">
		                          <col width="150px">                    
		                          <col width="200px" class="hide-area">
		                          <col width="200px">
		                          <col width="150px">                    
		                          <col width="*" class="hide-area">
		                        </colgroup>
		                        <thead class="table-thead">
		                          <tr>
		                            <th scope="col">구분</th>
		                            <th scope="col" class="hide-area">이름</th>
		                            <th scope="col" class="hide-area">등록/처리일시</th>
		                            <th scope="col">등급</th>
		                            <th scope="col">상태</th>
		                            <th scope="col">담당자 의견</th>
		                          </tr>
		                        </thead>
								<tbody id="tableId">
								</tbody>
		                    	<script type="text/x-jsrender" id="tableId_template">    
			                    	{{for list}}
										<tr>
											<td><button type="button" class="{{if APPROVAL_TYPE == "APPR"  }} col3-xs approval-btn-active{{else}}col3-xs approval-btn{{/if}}">
												{{:APPROVAL_TYPE_NM}}
												</button>
											</td>
											<td class="txt-l hide-area"><a href="">{{:APPROVAL_USER_NM}} </a></td>
											<td class="hide-area">{{:COMPLETE_DATE}}</td>
											<td>{{:GRADE}}</td>
											<td>{{:stateStr}}</td>
											<td class="tl">{{:APPROVAL_COMMENT}}</td>
										</tr>
    			    	            {{/for}}
                		    	</script>						
		                      </table>
		                      <!-- table end -->
		                    </div>
		                  </div>
		                </div>
		            </div>
		            <!-- table area end -->
		            <!-- 결재 진행 내용 end -->
		
		        </div>        
			</div>

			<div class="modal-footer">
				<button type="button" class="btn flat-btn" onclick="<@popupId>.cancelAppr()" style="display:none" id="<@popupId>_cancelappr">상신취소</button>
				<button type="button" class="btn outline-btn mr20" onClick="<@popupId>.close()">Close</button>
			</div>
		</div>
	</div>
</div>

